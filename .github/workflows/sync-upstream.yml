name: ğŸ”„ æ™ºèƒ½åŒæ­¥ä¸Šæ¸¸æ›´æ–°

on:
  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ä¸Šæ¸¸æ›´æ–°
  schedule:
    - cron: '0 * * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥å†²çªï¼‰'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-upstream:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: é…ç½®Gitç”¨æˆ·
      run: |
        git config user.name "DuanNaiSheQu-Bot"
        git config user.email "9788864@gmail.com"

    - name: æ·»åŠ ä¸Šæ¸¸è¿œç¨‹ä»“åº“
      run: |
        git remote add upstream https://github.com/Wei-Shaw/claude-relay-service.git || true
        git fetch upstream

    - name: æ£€æŸ¥ä¸Šæ¸¸æ˜¯å¦æœ‰æ–°æ›´æ–°
      id: check_updates
      run: |
        # è·å–ä¸Šæ¸¸æœ€æ–°æäº¤
        UPSTREAM_LATEST=$(git rev-parse upstream/main)
        
        # è·å–æˆ‘ä»¬æœ€ååŒæ­¥çš„ä¸Šæ¸¸æäº¤
        LAST_SYNC=$(git log --grep="Sync upstream" --format="%H" -n 1 || echo "")
        
        if [ -n "$LAST_SYNC" ]; then
          # æŸ¥æ‰¾æœ€åä¸€æ¬¡åŒæ­¥æ—¶çš„ä¸Šæ¸¸æäº¤
          LAST_UPSTREAM=$(git log --grep="upstream:" --format="%s" -n 1 | grep -o 'upstream:[a-f0-9]*' | cut -d':' -f2 || echo "")
        else
          LAST_UPSTREAM=""
        fi
        
        echo "æœ€æ–°ä¸Šæ¸¸æäº¤: $UPSTREAM_LATEST"
        echo "ä¸Šæ¬¡åŒæ­¥æäº¤: $LAST_UPSTREAM"
        
        if [ "$UPSTREAM_LATEST" != "$LAST_UPSTREAM" ]; then
          echo "å‘ç°æ–°çš„ä¸Šæ¸¸æ›´æ–°ï¼"
          echo "has_updates=true" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
          
          # è·å–æ›´æ–°çš„æ–‡ä»¶åˆ—è¡¨
          if [ -n "$LAST_UPSTREAM" ]; then
            CHANGED_FILES=$(git diff --name-only $LAST_UPSTREAM..$UPSTREAM_LATEST || echo "")
          else
            CHANGED_FILES=$(git diff --name-only upstream/main)
          fi
          
          echo "æ›´æ–°çš„æ–‡ä»¶:"
          echo "$CHANGED_FILES"
          
          # ä¿å­˜å˜æ›´æ–‡ä»¶åˆ—è¡¨
          echo "$CHANGED_FILES" > /tmp/changed_files.txt
        else
          echo "æ²¡æœ‰æ–°çš„ä¸Šæ¸¸æ›´æ–°"
          echo "has_updates=false" >> $GITHUB_OUTPUT
        fi

    - name: åˆ›å»ºæ™ºèƒ½åˆå¹¶ç­–ç•¥é…ç½®
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        # åˆ›å»ºåˆå¹¶ç­–ç•¥é…ç½®
        cat > /tmp/merge_strategy.txt << 'EOF'
        # éœ€è¦ä¿æŠ¤çš„å®šåˆ¶åŒ–æ–‡ä»¶ï¼ˆå®Œå…¨è·³è¿‡ï¼‰
        PROTECTED_FILES=(
          ".github/workflows/auto-release-pipeline.yml"
          "README.md" 
          "VERSION"
        )
        
        # éœ€è¦æ™ºèƒ½åˆå¹¶çš„æ–‡ä»¶ï¼ˆä¿ç•™å®šåˆ¶åŒ–å†…å®¹ï¼‰
        SMART_MERGE_FILES=(
          "docker-compose.yml"
          "package.json"
          ".github/workflows/*.yml"
        )
        
        # å®šåˆ¶åŒ–å†…å®¹æ ‡è¯†ç¬¦
        CUSTOM_MARKERS=(
          "DuanNaiSheQu"
          "claude-duannai" 
          "duannaishequ"
          "9788864@gmail.com"
        )
        EOF

    - name: æ‰§è¡Œæ™ºèƒ½åŒæ­¥
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "ğŸš€ å¼€å§‹æ™ºèƒ½åŒæ­¥ä¸Šæ¸¸æ›´æ–°..."
        
        # è¯»å–ç­–ç•¥é…ç½®
        source /tmp/merge_strategy.txt
        
        # åˆ›å»ºä¸´æ—¶åˆ†æ”¯
        TEMP_BRANCH="temp-sync-$(date +%s)"
        git checkout -b $TEMP_BRANCH
        
        # è¯»å–å˜æ›´æ–‡ä»¶
        CHANGED_FILES=$(cat /tmp/changed_files.txt)
        
        echo "ğŸ“‹ å¤„ç†å˜æ›´æ–‡ä»¶..."
        
        for file in $CHANGED_FILES; do
          echo "å¤„ç†æ–‡ä»¶: $file"
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯å—ä¿æŠ¤æ–‡ä»¶
          PROTECTED=false
          for protected in "${PROTECTED_FILES[@]}"; do
            if [[ "$file" == $protected ]]; then
              echo "  ğŸ›¡ï¸ è·³è¿‡å—ä¿æŠ¤æ–‡ä»¶: $file"
              PROTECTED=true
              break
            fi
          done
          
          if [ "$PROTECTED" = true ]; then
            continue
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºä¸Šæ¸¸
          if git show upstream/main:$file > /dev/null 2>&1; then
            # è·å–ä¸Šæ¸¸æ–‡ä»¶å†…å®¹
            git show upstream/main:$file > /tmp/upstream_file
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å®šåˆ¶åŒ–å†…å®¹
            HAS_CUSTOM=false
            if [ -f "$file" ]; then
              for marker in "${CUSTOM_MARKERS[@]}"; do
                if grep -q "$marker" "$file"; then
                  HAS_CUSTOM=true
                  echo "  âš ï¸ æ–‡ä»¶åŒ…å«å®šåˆ¶åŒ–å†…å®¹: $file"
                  break
                fi
              done
            fi
            
            if [ "$HAS_CUSTOM" = true ]; then
              echo "  ğŸ§  æ‰§è¡Œæ™ºèƒ½åˆå¹¶: $file"
              # åˆ›å»ºæ™ºèƒ½åˆå¹¶ç‰ˆæœ¬
              if [ -f "$file" ]; then
                # ä½¿ç”¨ä¸‰è·¯åˆå¹¶
                cp "$file" /tmp/current_file
                git show upstream/main:$file > /tmp/upstream_file
                
                # å°è¯•è‡ªåŠ¨åˆå¹¶
                if git merge-file /tmp/current_file /tmp/current_file /tmp/upstream_file; then
                  cp /tmp/current_file "$file"
                  echo "  âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ: $file"
                else
                  echo "  âš ï¸ éœ€è¦æ‰‹åŠ¨å¤„ç†å†²çª: $file"
                  # ä¿ç•™å½“å‰ç‰ˆæœ¬ï¼Œä½†æ·»åŠ æ³¨é‡Š
                  echo "# TODO: æ‰‹åŠ¨åˆå¹¶ä¸Šæ¸¸æ›´æ–° - $(date)" >> "$file"
                fi
              else
                # æ–°æ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶ä½†æ›¿æ¢å®šåˆ¶åŒ–æ ‡è¯†
                cp /tmp/upstream_file "$file"
                
                # æ›¿æ¢å®šåˆ¶åŒ–å†…å®¹
                sed -i 's/Wei-Shaw/DuanNaiSheQu/g' "$file" 2>/dev/null || true
                sed -i 's/claude-relay-service/claude-duannai/g' "$file" 2>/dev/null || true
                sed -i 's/weishaw/duannaishequ/g' "$file" 2>/dev/null || true
                
                echo "  âœ… æ–°æ–‡ä»¶å·²å®šåˆ¶åŒ–: $file"
              fi
            else
              echo "  ğŸ“„ ç›´æ¥æ›´æ–°æ–‡ä»¶: $file"
              # æ²¡æœ‰å®šåˆ¶åŒ–å†…å®¹ï¼Œç›´æ¥å¤åˆ¶
              git checkout upstream/main -- "$file" || cp /tmp/upstream_file "$file"
            fi
            
            # æš‚å­˜æ–‡ä»¶
            git add "$file"
          else
            echo "  ğŸ—‘ï¸ æ–‡ä»¶åœ¨ä¸Šæ¸¸å·²åˆ é™¤: $file"
            if [ -f "$file" ] && ! grep -q "DuanNaiSheQu\|claude-duannai\|duannaishequ" "$file"; then
              git rm "$file"
              echo "  âœ… å·²åˆ é™¤æ–‡ä»¶: $file"
            else
              echo "  ğŸ›¡ï¸ ä¿ç•™å®šåˆ¶åŒ–æ–‡ä»¶: $file"
            fi
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ²¡æœ‰éœ€è¦åŒæ­¥çš„å˜æ›´"
          exit 0
        fi
        
        # æäº¤å˜æ›´
        COMMIT_MSG="ğŸ”„ æ™ºèƒ½åŒæ­¥ä¸Šæ¸¸æ›´æ–°
        
        ğŸ“¦ åŒæ­¥æ¥æº: Wei-Shaw/claude-relay-service
        ğŸ”— ä¸Šæ¸¸æäº¤: upstream:${{ steps.check_updates.outputs.upstream_commit }}
        ğŸ“… åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        âœ¨ æ›´æ–°å†…å®¹:
        $(echo "$CHANGED_FILES" | sed 's/^/- /')
        
        ğŸ›¡ï¸ å·²ä¿æŠ¤å®šåˆ¶åŒ–å†…å®¹:
        - DuanNaiSheQu å“ç‰Œæ ‡è¯†
        - claude-duannai é¡¹ç›®åç§°  
        - ä¸“å±å·¥ä½œæµé…ç½®
        - ç‰ˆæœ¬å·ç®¡ç†
        
        ğŸ¤– Generated by DuanNaiSheQu Auto-Sync Bot"
        
        git commit -m "$COMMIT_MSG"
        
        # åˆ‡å›ä¸»åˆ†æ”¯å¹¶åˆå¹¶
        git checkout main
        git merge $TEMP_BRANCH --no-ff -m "Merge upstream sync"
        
        # æ¸…ç†ä¸´æ—¶åˆ†æ”¯
        git branch -d $TEMP_BRANCH
        
        echo "âœ… æ™ºèƒ½åŒæ­¥å®Œæˆï¼"

    - name: æ¨é€æ›´æ–°
      if: steps.check_updates.outputs.has_updates == 'true'
      run: |
        echo "ğŸ“¤ æ¨é€åŒæ­¥æ›´æ–°åˆ°ä»“åº“..."
        git push origin main

    - name: å‘é€åŒæ­¥é€šçŸ¥
      if: steps.check_updates.outputs.has_updates == 'true'
      continue-on-error: true
      env:
        UPSTREAM_COMMIT: ${{ steps.check_updates.outputs.upstream_commit }}
      run: |
        echo "ğŸ”” ä¸Šæ¸¸æ›´æ–°å·²æ™ºèƒ½åŒæ­¥åˆ°æ‚¨çš„ä»“åº“ï¼"
        echo "ğŸ“¦ åŒæ­¥çš„ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
        echo "ğŸ”— ä»“åº“åœ°å€: https://github.com/DuanNaiSheQu/claude-duannai"
        echo "âœ… æ‚¨çš„å®šåˆ¶åŒ–å†…å®¹å·²å¾—åˆ°ä¿æŠ¤"

    - name: åŒæ­¥çŠ¶æ€æŠ¥å‘Š
      if: always()
      run: |
        if [ "${{ steps.check_updates.outputs.has_updates }}" = "true" ]; then
          echo "âœ… åŒæ­¥çŠ¶æ€: æˆåŠŸ"
          echo "ğŸ“ˆ åŠŸèƒ½æ›´æ–°: å·²åŒæ­¥æœ€æ–°åŠŸèƒ½"
          echo "ğŸ›¡ï¸ å®šåˆ¶ä¿æŠ¤: å·²ä¿æŠ¤æ‚¨çš„å“ç‰ŒåŒ–å†…å®¹"
        else
          echo "â„¹ï¸ åŒæ­¥çŠ¶æ€: æ— æ–°æ›´æ–°"
          echo "ğŸ“Š æ£€æŸ¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        fi