name: âš¡ å®æ—¶ç²¾ç¡®ä»£ç åŒæ­¥

on:
  # GitHubä»“åº“æ¨é€äº‹ä»¶ (é€šè¿‡repository_dispatchè§¦å‘)
  repository_dispatch:
    types: [upstream_push]
  
  # å®šæœŸæ£€æŸ¥ä½œä¸ºå¤‡ä»½ (æ¯10åˆ†é’Ÿ)
  schedule:
    - cron: '*/10 * * * *'
    
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      upstream_commit:
        description: 'æŒ‡å®šä¸Šæ¸¸æäº¤SHA (ç•™ç©ºè‡ªåŠ¨æ£€æµ‹)'
        required: false
        type: string
      sync_mode:
        description: 'åŒæ­¥æ¨¡å¼'
        required: true
        default: 'smart'
        type: choice
        options:
        - smart
        - force
        - preview

permissions:
  contents: write
  pull-requests: write

jobs:
  realtime-sync:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ”„ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“‹ é…ç½®ç¯å¢ƒ
      run: |
        git config user.name "DuanNaiSheQu-RealTimeBot"
        git config user.email "9788864@gmail.com"
        
        # å®‰è£…å¿…è¦å·¥å…·
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: ğŸ”— è®¾ç½®ä¸Šæ¸¸è¿æ¥
      run: |
        git remote add upstream https://github.com/Wei-Shaw/claude-relay-service.git || true
        git fetch upstream --tags
        echo "âœ… ä¸Šæ¸¸è¿æ¥å·²å»ºç«‹"

    - name: ğŸ” ç²¾ç¡®æ£€æµ‹ä»£ç å˜æ›´
      id: detect_changes
      run: |
        echo "ğŸ” å¼€å§‹ç²¾ç¡®æ£€æµ‹ä¸Šæ¸¸ä»£ç å˜æ›´..."
        
        # è·å–æŒ‡å®šçš„ä¸Šæ¸¸æäº¤æˆ–æœ€æ–°æäº¤
        if [ -n "${{ github.event.inputs.upstream_commit }}" ]; then
          UPSTREAM_COMMIT="${{ github.event.inputs.upstream_commit }}"
        else
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
        fi
        
        echo "ğŸ¯ ç›®æ ‡ä¸Šæ¸¸æäº¤: $UPSTREAM_COMMIT"
        
        # æŸ¥æ‰¾æˆ‘ä»¬æœ€ååŒæ­¥çš„æäº¤
        LAST_SYNC_COMMIT=$(git log --grep="ç²¾ç¡®åŒæ­¥ä¸Šæ¸¸" --format="%H" -n 1 2>/dev/null || echo "")
        
        if [ -n "$LAST_SYNC_COMMIT" ]; then
          # ä»æäº¤æ¶ˆæ¯ä¸­æå–ä¸Šæ¬¡åŒæ­¥çš„ä¸Šæ¸¸æäº¤
          LAST_UPSTREAM=$(git log --format="%s %b" -n 1 $LAST_SYNC_COMMIT | grep -o 'upstream-commit:[a-f0-9]*' | cut -d':' -f2 2>/dev/null || echo "")
          echo "ğŸ“Œ ä¸Šæ¬¡åŒæ­¥çš„ä¸Šæ¸¸æäº¤: $LAST_UPSTREAM"
        else
          echo "âš ï¸ é¦–æ¬¡å®æ—¶åŒæ­¥"
          LAST_UPSTREAM=""
        fi
        
        if [ "$UPSTREAM_COMMIT" = "$LAST_UPSTREAM" ]; then
          echo "âœ… ä»£ç å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ğŸš¨ æ£€æµ‹åˆ°æ–°çš„ä»£ç å˜æ›´ï¼"
        echo "has_changes=true" >> $GITHUB_OUTPUT
        echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
        echo "last_upstream=$LAST_UPSTREAM" >> $GITHUB_OUTPUT
        
        # ç”Ÿæˆè¯¦ç»†çš„å˜æ›´åˆ†æ
        echo "ğŸ“Š åˆ†æä»£ç å˜æ›´è¯¦æƒ…..."
        
        if [ -n "$LAST_UPSTREAM" ]; then
          # è·å–å˜æ›´ç»Ÿè®¡
          STATS=$(git diff --stat $LAST_UPSTREAM..$UPSTREAM_COMMIT 2>/dev/null || git diff --stat upstream/main)
          CHANGED_FILES=$(git diff --name-only $LAST_UPSTREAM..$UPSTREAM_COMMIT 2>/dev/null || git diff --name-only upstream/main)
          
          # è·å–å…·ä½“çš„ä»£ç å˜æ›´
          echo "ğŸ“ ç”Ÿæˆè¯¦ç»†å˜æ›´æŠ¥å‘Š..."
          git diff --no-color $LAST_UPSTREAM..$UPSTREAM_COMMIT > /tmp/detailed_changes.patch
          
          # æå–æ–°å¢çš„æäº¤
          NEW_COMMITS=$(git log --oneline $LAST_UPSTREAM..$UPSTREAM_COMMIT 2>/dev/null || echo "åˆå§‹åŒæ­¥")
        else
          STATS="åˆå§‹åŒæ­¥"
          CHANGED_FILES=$(git diff --name-only upstream/main)
          NEW_COMMITS="åˆå§‹åŒæ­¥"
          git diff --no-color upstream/main > /tmp/detailed_changes.patch
        fi
        
        echo "ğŸ“ˆ å˜æ›´ç»Ÿè®¡:"
        echo "$STATS"
        echo
        echo "ğŸ“‚ å˜æ›´æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        echo
        echo "ğŸ“ æ–°å¢æäº¤:"
        echo "$NEW_COMMITS"
        
        # ä¿å­˜å˜æ›´ä¿¡æ¯
        echo "$STATS" > /tmp/change_stats.txt
        echo "$CHANGED_FILES" > /tmp/changed_files.txt
        echo "$NEW_COMMITS" > /tmp/new_commits.txt
        
        # åˆ†æå˜æ›´ç±»å‹
        echo "ğŸ”¬ åˆ†æå˜æ›´ç±»å‹..."
        
        FEATURE_COUNT=0
        BUG_COUNT=0
        DOC_COUNT=0
        CONFIG_COUNT=0
        
        while IFS= read -r commit_line; do
          if echo "$commit_line" | grep -qi "feat\|feature\|add\|æ–°å¢"; then
            FEATURE_COUNT=$((FEATURE_COUNT + 1))
          elif echo "$commit_line" | grep -qi "fix\|bug\|ä¿®å¤"; then
            BUG_COUNT=$((BUG_COUNT + 1))
          elif echo "$commit_line" | grep -qi "doc\|readme\|æ–‡æ¡£"; then
            DOC_COUNT=$((DOC_COUNT + 1))
          elif echo "$commit_line" | grep -qi "config\|é…ç½®\|è®¾ç½®"; then
            CONFIG_COUNT=$((CONFIG_COUNT + 1))
          fi
        done <<< "$NEW_COMMITS"
        
        echo "change_summary<<EOF" >> $GITHUB_OUTPUT
        echo "ğŸ¯ å˜æ›´ç±»å‹åˆ†æ:" >> $GITHUB_OUTPUT
        echo "  ğŸ’« æ–°åŠŸèƒ½: $FEATURE_COUNT ä¸ª" >> $GITHUB_OUTPUT
        echo "  ğŸ› Bugä¿®å¤: $BUG_COUNT ä¸ª" >> $GITHUB_OUTPUT
        echo "  ğŸ“– æ–‡æ¡£æ›´æ–°: $DOC_COUNT ä¸ª" >> $GITHUB_OUTPUT
        echo "  âš™ï¸ é…ç½®å˜æ›´: $CONFIG_COUNT ä¸ª" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ§  ç²¾ç¡®ä»£ç åˆ†æä¸åˆå¹¶
      if: steps.detect_changes.outputs.has_changes == 'true'
      id: precise_merge
      run: |
        echo "ğŸ§  å¼€å§‹ç²¾ç¡®ä»£ç åˆ†æä¸åˆå¹¶..."
        
        # è¯»å–é…ç½®
        if [ -f ".duannai-sync-config" ]; then
          source .duannai-sync-config
          echo "âœ… å·²åŠ è½½åŒæ­¥é…ç½®"
        fi
        
        # åˆ›å»ºå·¥ä½œåˆ†æ”¯
        WORK_BRANCH="realtime-sync-$(date +%s)"
        git checkout -b $WORK_BRANCH
        echo "ğŸ“ åˆ›å»ºå·¥ä½œåˆ†æ”¯: $WORK_BRANCH"
        
        # è¯»å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
        CHANGED_FILES=$(cat /tmp/changed_files.txt)
        
        echo "ğŸ”„ å¼€å§‹é€æ–‡ä»¶ç²¾ç¡®å¤„ç†..."
        
        SUCCESS_COUNT=0
        CONFLICT_COUNT=0
        PROTECTED_COUNT=0
        
        # åˆ›å»ºåˆå¹¶æŠ¥å‘Š
        echo "# ğŸ“Š ç²¾ç¡®ä»£ç åŒæ­¥æŠ¥å‘Š" > /tmp/merge_report.md
        echo "## ğŸ¯ åŒæ­¥ç›®æ ‡" >> /tmp/merge_report.md
        echo "- ä¸Šæ¸¸æäº¤: \`${{ steps.detect_changes.outputs.upstream_commit }}\`" >> /tmp/merge_report.md
        echo "- åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> /tmp/merge_report.md
        echo "" >> /tmp/merge_report.md
        echo "## ğŸ“‹ å¤„ç†è¯¦æƒ…" >> /tmp/merge_report.md
        
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          echo "ğŸ” å¤„ç†æ–‡ä»¶: $file"
          echo "### ğŸ“„ \`$file\`" >> /tmp/merge_report.md
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯å®Œå…¨ä¿æŠ¤çš„æ–‡ä»¶
          FULLY_PROTECTED=false
          case "$file" in
            ".github/workflows/auto-release-pipeline.yml"|"README.md"|"VERSION"|".duannai-sync-config"|"docs/SYNC_GUIDE.md")
              FULLY_PROTECTED=true
              ;;
          esac
          
          if [ "$FULLY_PROTECTED" = true ]; then
            echo "ğŸ›¡ï¸ è·³è¿‡å®Œå…¨ä¿æŠ¤æ–‡ä»¶: $file"
            echo "- çŠ¶æ€: ğŸ›¡ï¸ **å®Œå…¨ä¿æŠ¤** - è·³è¿‡åŒæ­¥" >> /tmp/merge_report.md
            PROTECTED_COUNT=$((PROTECTED_COUNT + 1))
            continue
          fi
          
          # æ£€æŸ¥ä¸Šæ¸¸æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if ! git show upstream/main:$file > /dev/null 2>&1; then
            echo "ğŸ—‘ï¸ æ–‡ä»¶åœ¨ä¸Šæ¸¸å·²åˆ é™¤: $file"
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å®šåˆ¶åŒ–å†…å®¹
            if [ -f "$file" ] && grep -q "DuanNaiSheQu\|claude-duannai\|duannaishequ" "$file" 2>/dev/null; then
              echo "ğŸ›¡ï¸ ä¿ç•™åŒ…å«å®šåˆ¶åŒ–å†…å®¹çš„æ–‡ä»¶: $file"
              echo "- çŠ¶æ€: ğŸ›¡ï¸ **ä¿ç•™** - åŒ…å«å®šåˆ¶åŒ–å†…å®¹" >> /tmp/merge_report.md
              PROTECTED_COUNT=$((PROTECTED_COUNT + 1))
            else
              echo "âŒ åˆ é™¤æ–‡ä»¶: $file"
              git rm "$file" 2>/dev/null || rm -f "$file"
              echo "- çŠ¶æ€: âŒ **å·²åˆ é™¤** - è·Ÿéšä¸Šæ¸¸åˆ é™¤" >> /tmp/merge_report.md
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            continue
          fi
          
          # è·å–ä¸Šæ¸¸æ–‡ä»¶å†…å®¹
          git show upstream/main:$file > "/tmp/upstream_$file.tmp"
          
          if [ -f "$file" ]; then
            # æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¿›è¡Œç²¾ç¡®åˆå¹¶
            echo "ğŸ”„ æ‰§è¡Œç²¾ç¡®ä»£ç åˆå¹¶: $file"
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å®šåˆ¶åŒ–å†…å®¹
            HAS_CUSTOM=false
            if grep -q "DuanNaiSheQu\|claude-duannai\|duannaishequ\|9788864@gmail.com" "$file" 2>/dev/null; then
              HAS_CUSTOM=true
              echo "âš ï¸ æ£€æµ‹åˆ°å®šåˆ¶åŒ–å†…å®¹"
            fi
            
            if [ "$HAS_CUSTOM" = true ]; then
              echo "ğŸ§  æ™ºèƒ½ä¸‰è·¯åˆå¹¶..."
              
              # åˆ›å»ºåˆå¹¶åŸºç¡€ç‰ˆæœ¬
              cp "$file" "/tmp/current_$file.tmp"
              
              # å°è¯•è‡ªåŠ¨åˆå¹¶
              if git merge-file "/tmp/current_$file.tmp" "/tmp/current_$file.tmp" "/tmp/upstream_$file.tmp" 2>/dev/null; then
                cp "/tmp/current_$file.tmp" "$file"
                echo "âœ… è‡ªåŠ¨åˆå¹¶æˆåŠŸ: $file"
                echo "- çŠ¶æ€: âœ… **æ™ºèƒ½åˆå¹¶æˆåŠŸ** - å·²ä¿æŠ¤å®šåˆ¶åŒ–å†…å®¹" >> /tmp/merge_report.md
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "âš ï¸ åˆå¹¶å†²çªï¼Œæ‰§è¡Œå†²çªè§£å†³..."
                
                # ç”Ÿæˆå†²çªæ ‡è®°ç‰ˆæœ¬ä»¥ä¾›åç»­å¤„ç†
                cp "/tmp/current_$file.tmp" "$file"
                
                # æ·»åŠ å†²çªæ ‡è®°
                echo "" >> "$file"
                echo "# âš ï¸ MERGE CONFLICT DETECTED - $(date)" >> "$file"
                echo "# æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œéœ€è¦äººå·¥å®¡æŸ¥" >> "$file"
                echo "# ä¸Šæ¸¸å˜æ›´å·²æ ‡è®°ï¼Œè¯·æ‰‹åŠ¨è§£å†³å†²çª" >> "$file"
                
                echo "âš ï¸ éœ€è¦æ‰‹åŠ¨è§£å†³å†²çª: $file"
                echo "- çŠ¶æ€: âš ï¸ **éœ€è¦æ‰‹åŠ¨å¤„ç†** - æ£€æµ‹åˆ°åˆå¹¶å†²çª" >> /tmp/merge_report.md
                CONFLICT_COUNT=$((CONFLICT_COUNT + 1))
              fi
            else
              echo "ğŸ“„ ç›´æ¥æ›´æ–°æ— å®šåˆ¶åŒ–æ–‡ä»¶: $file"
              
              # ç›´æ¥å¤åˆ¶å¹¶åº”ç”¨æ›¿æ¢
              cp "/tmp/upstream_$file.tmp" "$file"
              
              # åº”ç”¨å“ç‰Œæ›¿æ¢è§„åˆ™
              sed -i.bak 's/Wei-Shaw/DuanNaiSheQu/g' "$file" 2>/dev/null || true
              sed -i.bak 's/claude-relay-service/claude-duannai/g' "$file" 2>/dev/null || true  
              sed -i.bak 's/weishaw/duannaishequ/g' "$file" 2>/dev/null || true
              rm -f "$file.bak" 2>/dev/null || true
              
              echo "âœ… ç›´æ¥æ›´æ–°æˆåŠŸ: $file"
              echo "- çŠ¶æ€: âœ… **ç›´æ¥æ›´æ–°** - å·²åº”ç”¨å“ç‰Œæ›¿æ¢" >> /tmp/merge_report.md
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          else
            # æ–°æ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶å¹¶å®šåˆ¶åŒ–
            echo "ğŸ†• å¤„ç†æ–°æ–‡ä»¶: $file"
            
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            mkdir -p "$(dirname "$file")"
            cp "/tmp/upstream_$file.tmp" "$file"
            
            # åº”ç”¨å“ç‰Œæ›¿æ¢è§„åˆ™
            sed -i.bak 's/Wei-Shaw/DuanNaiSheQu/g' "$file" 2>/dev/null || true
            sed -i.bak 's/claude-relay-service/claude-duannai/g' "$file" 2>/dev/null || true
            sed -i.bak 's/weishaw/duannaishequ/g' "$file" 2>/dev/null || true
            rm -f "$file.bak" 2>/dev/null || true
            
            echo "âœ… æ–°æ–‡ä»¶å·²å®šåˆ¶åŒ–: $file"
            echo "- çŠ¶æ€: ğŸ†• **æ–°æ–‡ä»¶** - å·²åº”ç”¨å®šåˆ¶åŒ–" >> /tmp/merge_report.md
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          fi
          
          # æš‚å­˜æ–‡ä»¶
          git add "$file"
          
        done <<< "$CHANGED_FILES"
        
        # ç”Ÿæˆç»Ÿè®¡æ‘˜è¦
        echo "" >> /tmp/merge_report.md
        echo "## ğŸ“ˆ å¤„ç†ç»Ÿè®¡" >> /tmp/merge_report.md
        echo "- âœ… æˆåŠŸå¤„ç†: $SUCCESS_COUNT ä¸ªæ–‡ä»¶" >> /tmp/merge_report.md
        echo "- âš ï¸ éœ€è¦æ‰‹åŠ¨å¤„ç†: $CONFLICT_COUNT ä¸ªæ–‡ä»¶" >> /tmp/merge_report.md  
        echo "- ğŸ›¡ï¸ å—ä¿æŠ¤æ–‡ä»¶: $PROTECTED_COUNT ä¸ªæ–‡ä»¶" >> /tmp/merge_report.md
        
        echo "merge_stats=æˆåŠŸ:$SUCCESS_COUNT,å†²çª:$CONFLICT_COUNT,ä¿æŠ¤:$PROTECTED_COUNT" >> $GITHUB_OUTPUT
        echo "work_branch=$WORK_BRANCH" >> $GITHUB_OUTPUT

    - name: ğŸ’¾ æäº¤ç²¾ç¡®åŒæ­¥ç»“æœ
      if: steps.detect_changes.outputs.has_changes == 'true'
      id: commit_changes
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          echo "has_commits=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ğŸ’¾ æäº¤ç²¾ç¡®åŒæ­¥ç»“æœ..."
        
        # æ„å»ºè¯¦ç»†çš„æäº¤æ¶ˆæ¯
        COMMIT_MSG="âš¡ å®æ—¶ç²¾ç¡®åŒæ­¥ä¸Šæ¸¸ä»£ç å˜æ›´

ğŸ¯ åŒæ­¥ä¿¡æ¯:
$(cat /tmp/change_stats.txt)

ğŸ“¦ åŒæ­¥è¯¦æƒ…:
- ä¸Šæ¸¸ä»“åº“: Wei-Shaw/claude-relay-service
- upstream-commit:${{ steps.detect_changes.outputs.upstream_commit }}
- åŒæ­¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- å¤„ç†ç»Ÿè®¡: ${{ steps.precise_merge.outputs.merge_stats }}

${{ steps.detect_changes.outputs.change_summary }}

ğŸ“ æ–°å¢æäº¤:
$(cat /tmp/new_commits.txt)

ğŸ›¡ï¸ ä¿æŠ¤ç­–ç•¥:
- âœ… DuanNaiSheQu å“ç‰Œæ ‡è¯†å·²ä¿æŠ¤
- âœ… claude-duannai é¡¹ç›®åç§°å·²ä¿æŠ¤  
- âœ… ä¸“å±å·¥ä½œæµé…ç½®å·²ä¿æŠ¤
- âœ… å®šåˆ¶åŒ–å†…å®¹æ™ºèƒ½åˆå¹¶

ğŸ¤– Generated by DuanNaiSheQu Real-Time Sync Bot"
        
        git commit -m "$COMMIT_MSG"
        echo "âœ… å˜æ›´å·²æäº¤åˆ°å·¥ä½œåˆ†æ”¯"
        echo "has_commits=true" >> $GITHUB_OUTPUT

    - name: ğŸ”„ åˆå¹¶åˆ°ä¸»åˆ†æ”¯
      if: steps.commit_changes.outputs.has_commits == 'true'
      run: |
        echo "ğŸ”„ åˆå¹¶åŒæ­¥ç»“æœåˆ°ä¸»åˆ†æ”¯..."
        
        # åˆ‡æ¢åˆ°ä¸»åˆ†æ”¯
        git checkout main
        
        # åˆå¹¶å·¥ä½œåˆ†æ”¯
        git merge ${{ steps.precise_merge.outputs.work_branch }} --no-ff -m "ğŸ”„ Merge realtime upstream sync: $(date '+%Y-%m-%d %H:%M:%S')"
        
        echo "âœ… å·²åˆå¹¶åˆ°ä¸»åˆ†æ”¯"
        
        # æ¸…ç†å·¥ä½œåˆ†æ”¯
        git branch -D ${{ steps.precise_merge.outputs.work_branch }}
        echo "ğŸ§¹ å·²æ¸…ç†å·¥ä½œåˆ†æ”¯"

    - name: ğŸ“¤ æ¨é€åŒæ­¥ç»“æœ
      if: steps.commit_changes.outputs.has_commits == 'true'
      run: |
        echo "ğŸ“¤ æ¨é€å®æ—¶åŒæ­¥ç»“æœ..."
        git push origin main
        echo "âœ… åŒæ­¥ç»“æœå·²æ¨é€åˆ°è¿œç¨‹ä»“åº“"

    - name: ğŸ“Š ç”ŸæˆåŒæ­¥æŠ¥å‘Š
      if: always()
      run: |
        echo "ğŸ“Š ç”Ÿæˆæœ€ç»ˆåŒæ­¥æŠ¥å‘Š..."
        
        if [ "${{ steps.detect_changes.outputs.has_changes }}" = "true" ]; then
          if [ "${{ steps.commit_changes.outputs.has_commits }}" = "true" ]; then
            echo "## âœ… å®æ—¶åŒæ­¥æˆåŠŸå®Œæˆ"
            echo "ğŸ¯ **åŒæ­¥çŠ¶æ€**: æˆåŠŸ"
            echo "ğŸ“Š **å¤„ç†ç»Ÿè®¡**: ${{ steps.precise_merge.outputs.merge_stats }}"
            echo "â±ï¸ **å“åº”æ—¶é—´**: å®æ—¶å“åº”ä¸Šæ¸¸å˜æ›´"
            echo "ğŸ›¡ï¸ **ä¿æŠ¤çŠ¶æ€**: å®šåˆ¶åŒ–å†…å®¹å·²å®Œå…¨ä¿æŠ¤"
            echo "ğŸ”— **ä»“åº“åœ°å€**: https://github.com/DuanNaiSheQu/claude-duannai"
            
            # å¦‚æœæœ‰åˆå¹¶æŠ¥å‘Šï¼Œè¾“å‡ºå…³é”®ä¿¡æ¯
            if [ -f "/tmp/merge_report.md" ]; then
              echo ""
              echo "ğŸ“‹ **è¯¦ç»†å¤„ç†æŠ¥å‘Š**:"
              cat /tmp/merge_report.md | head -20
            fi
          else
            echo "## â„¹ï¸ æ— éœ€åŒæ­¥"
            echo "ğŸ“Š æ£€æµ‹åˆ°å˜æ›´ä½†æ— éœ€æäº¤"
          fi
        else
          echo "## âœ… ä»£ç å·²æ˜¯æœ€æ–°"
          echo "ğŸ“… æ£€æŸ¥æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ¯ æ— æ–°çš„ä»£ç å˜æ›´éœ€è¦åŒæ­¥"
        fi

    - name: ğŸš¨ é”™è¯¯å¤„ç†ä¸é€šçŸ¥
      if: failure()
      run: |
        echo "ğŸš¨ å®æ—¶åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼"
        echo "ğŸ“… é”™è¯¯æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ” è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "ğŸ› ï¸ å¯ä»¥æ‰‹åŠ¨è¿è¡Œ scripts/sync-upstream.sh è¿›è¡Œæ¢å¤"